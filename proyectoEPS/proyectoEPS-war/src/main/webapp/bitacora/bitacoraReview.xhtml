<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="../templates/template-one.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:o="http://omnifaces.org/ui"
                xmlns:cmp="http://xmlns.jcp.org/jsf/composite/components"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <f:metadata>
        <o:viewParam name="idProcess" required="true" 
                     value="#{bitacoraReview.processId}"
                     requiredMessage="Ningun valor">
            <o:viewParamValidationFailed sendError="404" message="Error parametro"/>
        </o:viewParam>
        <o:viewAction action="#{bitacoraReview.loadCurrentProject()}" />
    </f:metadata>
    <ui:define name="title">
        Bitacora
    </ui:define>
    <ui:define name="content">
        <h:form>
            <p:staticMessage severity="info" detail="Registro de Bitácora Vacio" rendered="#{bitacoraReview.journals.size() eq 0}"/>
            <br/>
            <p:commandLink styleClass="btn btn-warning" 
                           actionListener="#{bitacoraReview.enableJournal()}"
                           update="@form,:growl"
                           rendered="#{!bitacoraReview.process.approvedEPSDevelopment}">
                <p:confirm header="Habilitar Bitácora" message="¿Desea habilitar la Bitácora?" icon="pi pi-exclamation-triangle" />
                <span class="glyphicon glyphicon-ok-sign"></span> Habilitar Bitácora
            </p:commandLink>
            <p:accordionPanel value="#{bitacoraReview.journals}" var="journalLog" activeIndex="-2">
                <p:tab id="JournalLog" title="Fecha - #{journalLog.dateTime.dayOfMonth} / #{journalLog.dateTime.monthValue} / #{journalLog.dateTime.year}" >
                    <div>
                        <h4 class="text-primary">Actividad:</h4>
                    </div>
                    <div>
                        <h:outputLabel value="#{journalLog.activity}"/>
                    </div>
                    <div>
                        <h4 class="text-primary">Descripcion:</h4>
                    </div>
                    <div>
                        <h:outputLabel value="#{journalLog.description}"/>
                    </div>
                    <div>
                        <h4 class="text-primary">Imagenes:</h4>
                    </div>
                    <div>
                        <p:galleria value="#{journalLog.images}" var="imagen" >
                            <o:graphicImage value="#{imagen.image}" dataURI="true" height="450" width="600"/>
                        </p:galleria>
                    </div>
                    <div>
                        <h4 class="text-primary">Links:</h4>
                    </div>
                    <div>
                        <p:dataView value="#{journalLog.links}" var="link" >
                            <p:dataViewListItem>
                                <div>
                                    <a href="#{link.linkText}" target="_blank">#{link.linkText}</a>
                                </div>    
                            </p:dataViewListItem>
                        </p:dataView>
                    </div>
                    <div>
                        <br></br><p:commandLink styleClass="btn btn-primary"
                                                update=":#{p:component('comentar')}"
                                                oncomplete="PF('comentar').show();">
                            <f:setPropertyActionListener value="#{journalLog}" target="#{bitacoraReview.journalSelected}"/>
                            <span class="glyphicon glyphicon-comment"></span> Comentar
                        </p:commandLink>
                    </div>
                </p:tab>
            </p:accordionPanel>

        </h:form>
        <p:dialog header="Comentarios" id="comentar" widgetVar="comentar" 
                  modal="true" closeOnEscape="true">
            <p:ajax event="close" listener="#{bitacoraReview.cleanJournalSelected()}" update="@this" />
            <h:form>
                <fieldset>
                    <div class="col-md-12">
                        <div>
                            <p:dataTable id="commenTable" var="commentary" value="#{bitacoraReview.journalSelected.commentaries}" reflow="true">
                                <p:column headerText="Fecha">
                                    <h:outputText value="#{commentary.date}"/>
                                </p:column>
                                <p:column headerText="Por">
                                    <h:outputText value="#{commentary.user.firstName} #{commentary.user.lastName}"/>
                                </p:column>
                                <p:column headerText="Comentario">
                                    <h:outputText value="#{commentary.textValue}"/>
                                </p:column>
                            </p:dataTable>
                        </div>
                        <div>
                            <p:inputTextarea id="note" styleClass="form-control" required="true"
                                             rows="4" cols="50" maxlength="10000" placeholder="Indique los motivos"
                                             autoResize="false" value="#{bitacoraReview.commentText}"/>
                        </div>
                        <div>
                            <br></br><p:commandLink styleClass="btn btn-primary btn-xs"
                                                    update="@form"
                                                    actionListener="#{bitacoraReview.comment()}">
                                <span class="glyphicon glyphicon-trash"></span> Comentar
                            </p:commandLink>
                        </div>
                    </div>
                </fieldset>
            </h:form>
        </p:dialog>

        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
            <div class="col text-center">
                <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes"/>
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no"/>
            </div>
        </p:confirmDialog> 

    </ui:define>

</ui:composition>
